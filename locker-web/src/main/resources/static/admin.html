<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>관리자 화면</title>

  <style>
    * { box-sizing: border-box; }
    body{
      margin:0;
      padding:24px;
      background:#f5f6f8;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      color:#111;
    }
    .wrap{ max-width: 1100px; margin: 0 auto; display:grid; gap:16px; }
    .card{
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      border-radius:14px;
      padding:18px;
      box-shadow: 0 10px 25px rgba(0,0,0,.08);
    }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    h1{ margin:0; font-size:18px; font-weight:900; }
    .nav{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    a.btn, button{
      border:0;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:900;
      background:#111827;
      color:#fff;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    a.btn.secondary, button.secondary{
      background:#fff;
      color:#111827;
      border:1px solid #d8dbe2;
    }

    .grid2{ display:grid; gap:12px; grid-template-columns: 1.1fr .9fr; }
    @media (max-width: 920px){
      body{ padding:14px; }
      .grid2{ grid-template-columns: 1fr; }
    }

    /* Locker grid */
    .legend{ color:#4b5563; font-size:13px; margin-top:6px; }
    .lockerGrid{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(56px, 1fr));
      gap:10px;
      width:100%;
    }
    .cell{
      padding:14px 8px;
      border:1px solid #d1d5db;
      border-radius:12px;
      text-align:center;
      cursor:pointer;
      user-select:none;
      font-weight:900;
      transition:transform .05s ease, box-shadow .05s ease;
      background:#fff;
    }
    .cell:hover{transform:translateY(-1px); box-shadow:0 4px 10px rgba(0,0,0,.06);}
    .AVAILABLE{background:#aeeaae;}
    .RESERVED{background:#ffe796;}
    .APPROVED{background:#ffaaaa;}
    .cell small{ display:block; font-size:11px; font-weight:800; opacity:.8; margin-top:2px; }

    table{ width:100%; border-collapse: collapse; overflow:hidden; border-radius:12px; }
    th, td{ padding:10px 10px; border-bottom:1px solid #eee; text-align:left; font-size:14px; }
    th{ background:#f9fafb; font-size:13px; color:#444; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .msg{ margin-top:8px; min-height:18px; font-size:13px; color:#111; }
    .msg.err{ color:#dc2626; }
    .pill{ display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:#f1f5f9; color:#334155; border:1px solid #e2e8f0; }
  </style>
</head>

<body>
<div class="wrap">

  <div class="card topbar">
    <div>
      <h1>관리자 화면</h1>
      <div class="legend">사물함 현황 + 대기 신청 승인</div>
    </div>

    <div class="nav">
      <a class="btn secondary" href="/admin-approved.html">승인된 학생 / CSV</a>
      <a class="btn secondary" href="/admin-password.html">비밀번호 변경</a>
      <form method="post" action="/logout" style="margin:0;">
        <button type="submit" class="secondary">로그아웃</button>
      </form>
    </div>
  </div>

  <div class="grid2">
    <div class="card">
      <div class="topbar" style="margin-bottom:10px;">
        <h2 style="margin:0; font-size:15px; font-weight:900;">현재 사물함 현황</h2>
        <div class="actions">
          <button type="button" class="secondary" onclick="loadGrid()">새로고침</button>
        </div>
      </div>
      <div class="legend">초록=가능 / 노랑=대기예약 / 빨강=승인사용중 · <b>빨강 클릭</b> → 비우기</div>
      <div id="grid" class="lockerGrid" style="margin-top:12px;"></div>
      <div id="gridMsg" class="msg"></div>
    </div>

    <div class="card">
      <div class="topbar" style="margin-bottom:10px;">
        <h2 style="margin:0; font-size:15px; font-weight:900;">대기 신청 목록</h2>
        <button type="button" class="secondary" onclick="loadPending()">새로고침</button>
      </div>

      <div style="overflow:auto;">
        <table>
          <thead>
          <tr>
            <th>사물함</th>
            <th>학번</th>
            <th>이름</th>
            <th style="min-width:130px;">관리</th>
          </tr>
          </thead>
          <tbody id="pendingBody">
          <tr><td colspan="4" style="color:#6b7280;">불러오는 중...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="msg"><span class="pill">승인/거절 시 사물함 상태가 즉시 반영됩니다.</span></div>
    </div>
  </div>

</div>

<script>
  async function loadGrid(){
    const box = document.getElementById('gridMsg');
    box.className = 'msg';
    box.textContent = '';

    const grid = document.getElementById('grid');
    grid.innerHTML = '';

    const r = await fetch('/api/public/grid');
    if (!r.ok) {
      box.className = 'msg err';
      box.textContent = '사물함 현황을 불러오지 못했습니다. (서버 확인)';
      return;
    }

    const data = await r.json();
    data.forEach(item => {
      const div = document.createElement('div');
      div.className = 'cell ' + item.state;
      div.innerHTML = `${item.lockerNumber}<small>${item.state}</small>`;
      div.title = item.state + (item.studentId ? (' / ' + item.studentId) : '');

      // ✅ 빨강(승인) 클릭 시 비우기
      div.onclick = async () => {
        if (item.state !== 'APPROVED') return;
        const ok = confirm(`${item.lockerNumber}번 사물함을 비울까요?\n(승인 기록도 함께 삭제됩니다)`);
        if (!ok) return;

        const res = await fetch('/api/admin/clear/' + item.lockerNumber, { method:'POST' });
        if (!res.ok) {
          const t = await res.text();
          box.className = 'msg err';
          box.textContent = '비우기 실패: ' + t;
          return;
        }

        box.textContent = `${item.lockerNumber}번 사물함을 비웠습니다.`;
        await Promise.all([loadGrid(), loadPending()]);
      };

      grid.appendChild(div);
    });
  }

  async function loadPending(){
    const tbody = document.getElementById('pendingBody');
    tbody.innerHTML = `<tr><td colspan="4" style="color:#6b7280;">불러오는 중...</td></tr>`;

    const res = await fetch('/api/admin/pending');
    if (!res.ok) {
      tbody.innerHTML = `<tr><td colspan="4" style="color:#dc2626;">대기 목록을 불러오지 못했습니다. (권한/서버 확인)</td></tr>`;
      return;
    }

    const list = await res.json();
    if (!list.length) {
      tbody.innerHTML = `<tr><td colspan="4" style="color:#6b7280;">대기 중인 신청이 없습니다.</td></tr>`;
      return;
    }

    tbody.innerHTML = list.map(p => `
      <tr>
        <td>${p.lockerNumber}</td>
        <td>${p.studentId}</td>
        <td>${p.name}</td>
        <td>
          <div class="actions">
            <button type="button" onclick="approve(${p.id})">승인</button>
            <button type="button" class="secondary" onclick="reject(${p.id})">거절</button>
          </div>
        </td>
      </tr>
    `).join('');
  }

  async function approve(id){
    const res = await fetch('/api/admin/approve/' + id, { method:'POST' });
    if (!res.ok) {
      alert('승인 실패: ' + await res.text());
      return;
    }
    await Promise.all([loadPending(), loadGrid()]);
  }

  async function reject(id){
    const res = await fetch('/api/admin/reject/' + id, { method:'POST' });
    if (!res.ok) {
      alert('거절 실패: ' + await res.text());
      return;
    }
    await Promise.all([loadPending(), loadGrid()]);
  }

  // initial
  loadGrid();
  loadPending();
</script>

</body>
</html>
